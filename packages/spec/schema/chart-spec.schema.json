{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/chartcn-mobile/chartcn-mobile/main/packages/spec/schema/chart-spec.schema.json",
  "title": "ChartSpec",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "specVersion",
    "id",
    "metadata",
    "data",
    "visual",
    "accessibility"
  ],
  "properties": {
    "specVersion": {
      "type": "string",
      "pattern": "^1\\.[0-9]+\\.[0-9]+$",
      "description": "ChartSpec major/minor/patch version. Current major: 1."
    },
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9]+([.-][a-z0-9]+)*$",
      "description": "Stable identifier for registry, analytics, and migrations."
    },
    "metadata": {
      "$ref": "#/$defs/metadata"
    },
    "data": {
      "$ref": "#/$defs/data"
    },
    "visual": {
      "$ref": "#/$defs/visual"
    },
    "formatting": {
      "$ref": "#/$defs/formatting"
    },
    "interactions": {
      "$ref": "#/$defs/interactions"
    },
    "theming": {
      "$ref": "#/$defs/theming"
    },
    "accessibility": {
      "$ref": "#/$defs/accessibility"
    },
    "platformOverrides": {
      "$ref": "#/$defs/platformOverrides"
    }
  },
  "$defs": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "status", "owners"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "status": {
          "type": "string",
          "enum": ["experimental", "beta", "stable", "deprecated"]
        },
        "owners": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_.@-]+$" },
          "minItems": 1,
          "uniqueItems": true
        },
        "updatedAt": {
          "type": "string",
          "format": "date"
        }
      }
    },
    "data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source", "dimensions", "measures"],
      "properties": {
        "source": {
          "oneOf": [
            { "$ref": "#/$defs/swiftdataSource" },
            { "$ref": "#/$defs/roomSource" },
            { "$ref": "#/$defs/sqldelightSource" },
            { "$ref": "#/$defs/apiSource" },
            { "$ref": "#/$defs/staticSource" }
          ]
        },
        "dimensions": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/dimension" }
        },
        "measures": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/measure" }
        },
        "filters": {
          "type": "array",
          "items": { "$ref": "#/$defs/filter" }
        },
        "transforms": {
          "type": "array",
          "items": {
            "oneOf": [
              { "$ref": "#/$defs/sortTransform" },
              { "$ref": "#/$defs/movingAverageTransform" },
              { "$ref": "#/$defs/cumulativeTransform" },
              { "$ref": "#/$defs/groupTransform" }
            ]
          }
        }
      }
    },
    "swiftdataSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter", "entity"],
      "properties": {
        "adapter": { "const": "swiftdata" },
        "entity": { "type": "string", "minLength": 1 },
        "predicate": { "type": "string" },
        "sort": {
          "type": "array",
          "items": { "$ref": "#/$defs/orderBy" }
        },
        "limit": { "type": "integer", "minimum": 1 }
      }
    },
    "roomSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter", "table"],
      "properties": {
        "adapter": { "const": "room" },
        "table": { "type": "string", "minLength": 1 },
        "where": { "type": "string" },
        "args": {
          "type": "array",
          "items": { "type": ["string", "number", "boolean", "null"] }
        },
        "orderBy": {
          "type": "array",
          "items": { "$ref": "#/$defs/orderBy" }
        },
        "limit": { "type": "integer", "minimum": 1 }
      }
    },
    "sqldelightSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter", "queryName"],
      "properties": {
        "adapter": { "const": "sqldelight" },
        "queryName": { "type": "string", "minLength": 1 },
        "args": {
          "type": "object",
          "additionalProperties": {
            "type": ["string", "number", "boolean", "null"]
          }
        }
      }
    },
    "apiSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter", "endpoint", "method"],
      "properties": {
        "adapter": { "const": "api" },
        "endpoint": { "type": "string", "minLength": 1 },
        "method": { "type": "string", "enum": ["GET", "POST"] },
        "headers": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "query": {
          "type": "object",
          "additionalProperties": {
            "type": ["string", "number", "boolean", "null"]
          }
        },
        "body": {
          "type": "object",
          "additionalProperties": true
        },
        "dataPath": { "type": "string" }
      }
    },
    "staticSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter", "rows"],
      "properties": {
        "adapter": { "const": "static" },
        "rows": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": {
              "type": ["string", "number", "boolean", "null"]
            }
          }
        }
      }
    },
    "dimension": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key", "type", "label"],
      "properties": {
        "key": { "type": "string" },
        "type": { "type": "string", "enum": ["time", "string", "number", "boolean"] },
        "label": { "type": "string" }
      }
    },
    "measure": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key", "type", "label"],
      "properties": {
        "key": { "type": "string" },
        "type": { "type": "string", "enum": ["number", "duration", "percent", "currency"] },
        "label": { "type": "string" },
        "unit": { "type": "string" },
        "currency": { "type": "string", "minLength": 3, "maxLength": 3 }
      }
    },
    "filter": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "op", "value"],
      "properties": {
        "field": { "type": "string" },
        "op": { "type": "string", "enum": ["eq", "neq", "gt", "gte", "lt", "lte", "in", "between", "contains"] },
        "value": {
          "type": ["string", "number", "boolean", "null", "array"],
          "items": { "type": ["string", "number", "boolean", "null"] }
        }
      }
    },
    "orderBy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "direction"],
      "properties": {
        "field": { "type": "string" },
        "direction": { "type": "string", "enum": ["asc", "desc"] }
      }
    },
    "sortTransform": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "by", "direction"],
      "properties": {
        "type": { "const": "sort" },
        "by": { "type": "string" },
        "direction": { "type": "string", "enum": ["asc", "desc"] }
      }
    },
    "movingAverageTransform": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "input", "window", "as"],
      "properties": {
        "type": { "const": "movingAverage" },
        "input": { "type": "string" },
        "window": { "type": "integer", "minimum": 2 },
        "as": { "type": "string" }
      }
    },
    "cumulativeTransform": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "input", "as"],
      "properties": {
        "type": { "const": "cumulative" },
        "input": { "type": "string" },
        "as": { "type": "string" }
      }
    },
    "groupTransform": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "by", "aggregations"],
      "properties": {
        "type": { "const": "group" },
        "by": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "aggregations": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["field", "op", "as"],
            "properties": {
              "field": { "type": "string" },
              "op": { "type": "string", "enum": ["sum", "avg", "min", "max", "count"] },
              "as": { "type": "string" }
            }
          }
        }
      }
    },
    "visual": {
      "type": "object",
      "additionalProperties": false,
      "required": ["chartType", "series"],
      "properties": {
        "chartType": {
          "type": "string",
          "enum": ["line", "bar", "area", "pie", "donut", "scatter", "combo", "kpi"]
        },
        "xField": { "type": "string" },
        "groupField": { "type": "string" },
        "stacked": { "type": "boolean", "default": false },
        "series": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/series" }
        },
        "legend": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "visible": { "type": "boolean", "default": true },
            "position": { "type": "string", "enum": ["top", "bottom", "left", "right"] }
          }
        },
        "axes": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "x": { "$ref": "#/$defs/axis" },
            "y": { "$ref": "#/$defs/axis" }
          }
        },
        "tooltip": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "mode": { "type": "string", "enum": ["nearest", "index"] }
          }
        },
        "emptyState": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string" },
            "description": { "type": "string" }
          }
        }
      }
    },
    "series": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "label"],
      "properties": {
        "field": { "type": "string" },
        "label": { "type": "string" },
        "renderer": {
          "type": "string",
          "enum": ["line", "bar", "area", "scatter", "kpi"]
        },
        "style": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "color": { "type": "string" },
            "lineWidth": { "type": "number", "minimum": 0 },
            "dash": {
              "type": "array",
              "items": { "type": "number", "minimum": 0 },
              "minItems": 2
            },
            "opacity": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        }
      }
    },
    "axis": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "label": { "type": "string" },
        "min": { "type": "number" },
        "max": { "type": "number" },
        "tickCount": { "type": "integer", "minimum": 2 }
      }
    },
    "formatting": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "number": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "notation": { "type": "string", "enum": ["standard", "compact"] },
            "maximumFractionDigits": { "type": "integer", "minimum": 0, "maximum": 8 }
          }
        },
        "currency": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "code": { "type": "string", "minLength": 3, "maxLength": 3 },
            "display": { "type": "string", "enum": ["symbol", "code", "name"] }
          }
        },
        "date": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "granularity": { "type": "string", "enum": ["hour", "day", "week", "month", "quarter", "year"] }
          }
        }
      }
    },
    "interactions": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "selection": { "type": "string", "enum": ["none", "single", "multiple"] },
        "drilldown": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean" },
            "targetRoute": { "type": "string" },
            "paramField": { "type": "string" }
          }
        },
        "gestures": {
          "type": "array",
          "items": { "type": "string", "enum": ["pan", "pinch", "tap", "longPress"] },
          "uniqueItems": true
        }
      }
    },
    "theming": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "palette": { "type": "string" },
        "tokens": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    },
    "accessibility": {
      "type": "object",
      "additionalProperties": false,
      "required": ["chartTitle", "summaryTemplate"],
      "properties": {
        "chartTitle": { "type": "string", "minLength": 1 },
        "summaryTemplate": { "type": "string", "minLength": 1 },
        "announceOnLoad": { "type": "boolean", "default": true }
      }
    },
    "platformOverrides": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ios": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "interpolation": { "type": "string", "enum": ["linear", "monotone", "catmullRom"] },
            "symbolSize": { "type": "number", "minimum": 0 }
          }
        },
        "android": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "curveStyle": { "type": "string", "enum": ["straight", "smooth"] },
            "pointRadius": { "type": "number", "minimum": 0 }
          }
        }
      }
    }
  }
}
